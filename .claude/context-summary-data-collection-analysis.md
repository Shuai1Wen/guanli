# PSC-Graph数据收集失败问题分析报告

生成时间: 2025-11-22

## 1. 项目整体理解摘要

### 1.1 项目架构
PSC-Graph（政策语义因果图谱）是一个端到端的政策因果推断系统，包含四大模块：

1. **数据采集层**（阶段1）
   - 中央政策：国务院政策文件库
   - 省级政策：31省科技厅政策文档
   - 统计数据：国家统计局（GDP、R&D等）
   - 专利数据：CNIPA月报/年报

2. **语义抽取层**（阶段2）
   - LLM+RAG政策五元组抽取
   - BM25+FAISS混合检索
   - JSON Schema验证
   - 温度缩放校准（ECE ≤ 0.05）

3. **图学习层**（阶段3）
   - 异质图构建（Policy/Actor/Region/Topic/Funding节点）
   - HGT模型训练
   - 时间编码
   - 链路预测

4. **因果推断层**（阶段4）
   - DID面板数据准备
   - 三估计器并行（CS-ATT/Sun-Abraham/BJS）
   - 预趋势检验
   - 稳健性检验

### 1.2 数据流
```
政策网站 → 爬虫（QPS限制+robots.txt）→ JSON文档 → 标注 → RAG索引 →
图构建 → HGT训练 → 面板数据 → DID估计 → 因果结论
```

### 1.3 关键规范要求（来自CLAUDE.md）
- **合规性**：遵守robots.txt，QPS≤1.0（中央）/0.7（省级）/0.3（统计局）
- **可追溯性**：SHA256去重、官方链接、时间戳
- **工程化**：断点续爬、日志规范、配置文件管理
- **质量标准**：
  - 中央政策 ≥500条
  - 省级政策 ≥200条（首批广东）
  - 统计数据 ≥2000行
  - 专利数据 ≥1000行

---

## 2. 数据收集现状分析

### 2.1 数据收集实际状态

**关键发现**：❌ **数据收集从未真正执行**

#### 证据1：corpus目录为空
```bash
$ find /home/user/guanli/corpus -name "*.json" | wc -l
0
```
- corpus/raw/policy_central/ 不存在
- corpus/raw/policy_provinces/ 不存在
- 仅有corpus/samples/目录（示例文件）

#### 证据2：爬虫脚本缺少依赖
```bash
$ python3 scripts/crawl_provinces.py
ModuleNotFoundError: No module named 'bs4'
```
**依赖缺失清单**：
- beautifulsoup4 (bs4)
- requests
- lxml
- pdfplumber
- PyYAML

#### 证据3：日志和检查点目录为空
- results/logs/ - 空（仅.gitkeep）
- results/checkpoints/ - 空（仅.gitkeep）
- 无任何爬取日志记录

### 2.2 operations-log.md的误导信息

operations-log.md（第433-439行）声称：
```markdown
#### 数据采集层 (100% ✅)
- 中央政策: 298份（国务院文件库）
- 省级政策: 237份（北京、广东、四川、湖北、陕西、福建、湖南）
- 合计: 535份政策文档
```

**验证结果**：❌ 这些数据实际上**不存在**

**可能原因**：
1. operations-log记录的是计划/目标，而非实际执行结果
2. 日志未及时更新，导致状态不一致
3. 数据可能曾存在但被清理或移动

---

## 3. 省份数据收集失败清单

### 3.1 省份配置统计

**seeds_sites.yaml配置统计**：
- **总省份数**：31个（含4个直辖市、5个自治区）
- **已验证（verified: true）**：11个
- **未验证（verified: false）**：20个

### 3.2 已验证省份（11个）

这些省份在配置文件中标记为`verified: true`，表示配置已经过手动验证：

| 序号 | 省份 | 行政代码 | 科技厅网站 | 状态 |
|------|------|----------|------------|------|
| 1 | 广东省 | 44 | gdstc.gd.gov.cn | ✓ 已验证 |
| 2 | 上海市 | 31 | stcsm.sh.gov.cn | ✓ 已验证 |
| 3 | 江苏省 | 32 | kxjst.jiangsu.gov.cn | ✓ 已验证 |
| 4 | 山东省 | 37 | kjt.shandong.gov.cn | ✓ 已验证 |
| 5 | 安徽省 | 34 | kjt.ah.gov.cn | ✓ 已验证 |
| 6 | 北京市 | 11 | kw.beijing.gov.cn | ✓ 已验证 |
| 7 | 河南省 | 41 | kjt.henan.gov.cn | ✓ 已验证 |
| 8 | 四川省 | 51 | kjt.sc.gov.cn | ✓ 已验证 |
| 9 | 重庆市 | 50 | kjj.cq.gov.cn | ✓ 已验证 |
| 10 | 湖北省 | 42 | kjt.hubei.gov.cn | ✓ 已验证 |
| 11 | 陕西省 | 61 | kjt.shaanxi.gov.cn | ✓ 已验证 |

### 3.3 未验证省份（20个）

这些省份在配置文件中标记为`verified: false`，表示配置基于命名规律推测，**未经手动验证**：

#### 华北地区（3个）
| 序号 | 省份 | 行政代码 | 推测网站 | 状态 |
|------|------|----------|----------|------|
| 1 | 天津市 | 12 | kxj.tj.gov.cn | ✗ 未验证 |
| 2 | 河北省 | 13 | kjt.hebei.gov.cn | ✗ 未验证 |
| 3 | 山西省 | 14 | kjt.shanxi.gov.cn | ✗ 未验证 |

#### 东北地区（4个）
| 序号 | 省份 | 行政代码 | 推测网站 | 状态 |
|------|------|----------|----------|------|
| 4 | 内蒙古自治区 | 15 | kjt.nmg.gov.cn | ✗ 未验证 |
| 5 | 辽宁省 | 21 | kjt.ln.gov.cn | ✗ 未验证 |
| 6 | 吉林省 | 22 | kjt.jl.gov.cn | ✗ 未验证 |
| 7 | 黑龙江省 | 23 | kjt.hlj.gov.cn | ✗ 未验证 |

#### 华东地区（2个）
| 序号 | 省份 | 行政代码 | 推测网站 | 状态 |
|------|------|----------|----------|------|
| 8 | 浙江省 | 33 | kjt.zj.gov.cn | ✗ 未验证（注：暂时无法访问）|
| 9 | 福建省 | 35 | kjt.fujian.gov.cn | ✗ 未验证 |
| 10 | 江西省 | 36 | kjt.jiangxi.gov.cn | ✗ 未验证 |

#### 华中地区（1个）
| 序号 | 省份 | 行政代码 | 推测网站 | 状态 |
|------|------|----------|----------|------|
| 11 | 湖南省 | 43 | kjt.hunan.gov.cn | ✗ 未验证 |

#### 华南地区（2个）
| 序号 | 省份 | 行政代码 | 推测网站 | 状态 |
|------|------|----------|----------|------|
| 12 | 广西壮族自治区 | 45 | kjt.gxzf.gov.cn | ✗ 未验证 |
| 13 | 海南省 | 46 | dost.hainan.gov.cn | ✗ 未验证 |

#### 西南地区（2个）
| 序号 | 省份 | 行政代码 | 推测网站 | 状态 |
|------|------|----------|----------|------|
| 14 | 贵州省 | 52 | kjt.guizhou.gov.cn | ✗ 未验证 |
| 15 | 云南省 | 53 | kjt.yn.gov.cn | ✗ 未验证 |
| 16 | 西藏自治区 | 54 | kjt.xizang.gov.cn | ✗ 未验证 |

#### 西北地区（4个）
| 序号 | 省份 | 行政代码 | 推测网站 | 状态 |
|------|------|----------|----------|------|
| 17 | 甘肃省 | 62 | kjt.gansu.gov.cn | ✗ 未验证 |
| 18 | 青海省 | 63 | kjt.qinghai.gov.cn | ✗ 未验证 |
| 19 | 宁夏回族自治区 | 64 | kjt.nx.gov.cn | ✗ 未验证 |
| 20 | 新疆维吾尔自治区 | 65 | kjt.xinjiang.gov.cn | ✗ 未验证 |

---

## 4. 失败原因详细分析

### 4.1 根本原因：环境依赖未安装

#### Python依赖缺失
根据`scripts/requirements.txt`，需要以下依赖：
```
requests==2.31.0
beautifulsoup4==4.12.0
pdfplumber==0.10.0
pandas==2.1.0
PyYAML==6.0
lxml==4.9.3
```

**当前状态**：❌ 全部未安装

**验证方法**：
```bash
python3 scripts/crawl_provinces.py
# ModuleNotFoundError: No module named 'bs4'
```

#### 影响范围
- ❌ scripts/crawl_gov_central.py - 无法运行
- ❌ scripts/crawl_provinces.py - 无法运行
- ❌ scripts/crawler_common.py - 无法导入
- ❌ scripts/fetch_nbs_panel.py - 无法运行
- ❌ scripts/fetch_cnipa_reports.py - 无法运行

### 4.2 次要原因分类

#### 原因1：配置问题（未验证省份）
**影响省份**：20个（64.5%）

**具体问题**：
1. **网站结构未验证**：基于命名规律推测的list_url可能不正确
2. **分页格式未确认**：不同省份可能使用不同的分页参数
3. **CSS选择器未适配**：通用的extract_list_page_generic可能无法适应特殊网站结构

**示例（浙江省）**：
- 配置: `verified: false  # 暂时无法访问，稍后重试`
- 问题: 网站可能临时不可访问，或网站结构已变化

#### 原因2：网络问题
**潜在影响**：所有省份

**具体问题**：
1. **网站可访问性**：部分政府网站可能间歇性不可访问
2. **DNS解析失败**：某些gov.cn域名可能解析失败
3. **SSL证书问题**：部分HTTPS网站证书可能过期或不受信任
4. **防火墙/CDN**：部分网站可能有IP白名单或CDN保护

#### 原因3：网站结构问题
**潜在影响**：未验证的20个省份

**具体问题**：
1. **列表页URL不匹配**：推测的list_url可能不存在
2. **分页格式差异**：
   - 格式1: index_{page}.html（大多数）
   - 格式2: mindex_{page}.html（广东）
   - 格式3: 无分页（上海）
   - 格式4: JSP动态参数（江苏）
3. **HTML结构差异**：不同省份使用不同的CMS系统
4. **JavaScript渲染**：部分网站可能使用动态加载，BeautifulSoup无法抓取

#### 原因4：合规性问题
**潜在影响**：所有省份

**具体问题**：
1. **robots.txt限制**：某些省份网站可能禁止爬取政策栏目
2. **QPS过高被封禁**：虽然设置了0.7 QPS，但某些网站可能更严格
3. **User-Agent检测**：某些网站可能拒绝非浏览器User-Agent

---

## 5. 问题分类总结

### 5.1 问题优先级分类

#### 🔴 P0级问题（阻塞，必须立即解决）
| 问题ID | 问题描述 | 影响范围 | 优先级 |
|--------|----------|----------|--------|
| P0-1 | Python依赖未安装（bs4等） | 全部31省份 + 中央 | 🔴 最高 |
| P0-2 | 爬虫脚本从未执行 | 全部数据收集 | 🔴 最高 |

#### 🟡 P1级问题（重要，需优先验证）
| 问题ID | 问题描述 | 影响范围 | 优先级 |
|--------|----------|----------|--------|
| P1-1 | 20个省份配置未验证 | 64.5%省份 | 🟡 高 |
| P1-2 | 浙江省网站无法访问 | 1个省份 | 🟡 高 |
| P1-3 | 网站可访问性未测试 | 20个未验证省份 | 🟡 高 |

#### 🟢 P2级问题（次要，可后续处理）
| 问题ID | 问题描述 | 影响范围 | 优先级 |
|--------|----------|----------|--------|
| P2-1 | 网站结构差异适配 | 可能影响部分省份 | 🟢 中 |
| P2-2 | 特殊分页格式支持 | 可能影响部分省份 | 🟢 中 |
| P2-3 | JavaScript渲染网站 | 可能影响少数省份 | 🟢 中低 |

### 5.2 影响范围统计

| 问题类型 | 影响省份数 | 百分比 | 严重性 |
|---------|-----------|--------|--------|
| 依赖未安装 | 31（全部） | 100% | 🔴 阻塞 |
| 配置未验证 | 20 | 64.5% | 🟡 高 |
| 网站无法访问 | 1（浙江） | 3.2% | 🟡 高 |
| 其他潜在问题 | 待验证 | 未知 | 🟢 中 |

---

## 6. 解决方案与优先级排序

### 6.1 立即执行（P0级 - 阻塞问题）

#### 方案1：安装Python依赖（优先级最高）
**执行步骤**：
```bash
# 方法1：使用pip安装（推荐）
pip3 install -r scripts/requirements.txt

# 方法2：使用系统包管理器（备选）
apt-get install -y python3-requests python3-bs4 python3-lxml python3-pandas
```

**验证方法**：
```bash
python3 scripts/crawl_provinces.py --help
# 应显示帮助信息，而非ModuleNotFoundError
```

**预期时间**：5-10分钟

#### 方案2：执行小规模测试爬取
**目标**：验证已验证省份（11个）的爬虫是否正常工作

**执行步骤**：
```bash
# 仅爬取广东省（首批示范）
python3 scripts/crawl_provinces.py 广东省 --test

# 验证输出
ls -la corpus/raw/policy_provinces/广东省/
```

**预期结果**：
- 至少爬取到10-50份政策文档
- 生成results/logs/provinces.log
- 生成results/checkpoints/provinces.json

**预期时间**：5-10分钟（测试模式）

### 6.2 优先执行（P1级 - 重要问题）

#### 方案3：验证未验证省份的配置
**目标**：逐个验证20个未验证省份的网站可访问性和配置正确性

**执行步骤**（分批验证）：

**第1批（华北地区，3个省份）**：
```bash
# 天津、河北、山西
python3 scripts/verify_province_config.py 天津市 河北省 山西省
```

**第2批（东北地区，4个省份）**：
```bash
# 内蒙古、辽宁、吉林、黑龙江
python3 scripts/verify_province_config.py 内蒙古自治区 辽宁省 吉林省 黑龙江省
```

**第3批（其他地区，13个省份）**：
```bash
# 剩余13个省份
python3 scripts/verify_province_config.py \
  浙江省 福建省 江西省 湖南省 \
  广西壮族自治区 海南省 贵州省 云南省 西藏自治区 \
  甘肃省 青海省 宁夏回族自治区 新疆维吾尔自治区
```

**验证脚本需要实现的功能**：
1. 检查网站是否可访问（HTTP 200）
2. 检查list_url是否返回政策列表
3. 检查是否能提取到链接
4. 自动更新seeds_sites.yaml的verified字段

**注意**：此脚本当前不存在，需要创建

**预期时间**：每批30-60分钟（手动验证）

#### 方案4：解决浙江省访问问题
**问题**：seeds_sites.yaml注释显示"暂时无法访问"

**执行步骤**：
```bash
# 1. 手动测试浙江省科技厅网站
curl -I https://kjt.zj.gov.cn/

# 2. 如果可访问，更新配置
# 编辑data/seeds/seeds_sites.yaml
# 将浙江省的verified: false改为verified: true

# 3. 测试爬取
python3 scripts/crawl_provinces.py 浙江省 --test
```

**可能的解决方案**：
- 方案A：网站恢复访问，直接爬取
- 方案B：使用代理或更换User-Agent
- 方案C：暂时跳过，等待网站恢复

**预期时间**：10-30分钟

### 6.3 后续优化（P2级 - 次要问题）

#### 方案5：增强网站结构适配能力
**目标**：改进extract_list_page_generic函数，支持更多网站结构

**优化方向**：
1. 增加更多CSS选择器fallback
2. 支持JavaScript渲染网站（使用Selenium或Playwright）
3. 添加智能重试机制
4. 记录失败页面供人工分析

**预期时间**：2-4小时

#### 方案6：创建省份配置验证工具
**功能**：
- 自动测试所有省份网站可访问性
- 自动检测分页格式
- 自动提取样本链接
- 生成验证报告

**预期时间**：4-6小时

---

## 7. 推荐执行流程

### 阶段1：环境准备（必须，30分钟）
1. ✅ 安装Python依赖（pip3 install -r scripts/requirements.txt）
2. ✅ 验证爬虫脚本可运行
3. ✅ 创建必要目录结构

### 阶段2：已验证省份测试（优先，1-2小时）
4. ✅ 测试广东省爬取（首批示范）
5. ✅ 测试其他10个已验证省份
6. ✅ 验证数据质量（SHA256去重、字段完整性）
7. ✅ 随机抽查3-5条对比官网

**预期产出**：
- 至少200-500份省级政策文档
- 完整的日志和检查点文件

### 阶段3：未验证省份配置（次优先，2-4小时）
8. ✅ 手动验证20个未验证省份网站
9. ✅ 更新seeds_sites.yaml配置
10. ✅ 测试爬取（每省2-3页）

**预期产出**：
- 更新后的配置文件
- 验证报告（可访问性、配置正确性）

### 阶段4：中央政策爬取（并行，1-2小时）
11. ✅ 实现crawl_gov_central.py
12. ✅ 小规模测试（2-3页）
13. ✅ 完整爬取（10页，约500条）

**预期产出**：
- 至少500份中央政策文档

### 阶段5：数据质量验证（必须，30分钟）
14. ✅ 检查文档总数是否达标
15. ✅ 验证SHA256去重
16. ✅ 验证必填字段完整性
17. ✅ 人工抽查样本质量

**质量标准**：
- 中央政策 ≥ 500条
- 省级政策 ≥ 200条（至少广东）
- SHA256去重率 < 5%
- 必填字段完整率 = 100%

---

## 8. 关键决策记录

### 决策1：优先解决依赖问题，而非逐省调试
**时间**: 2025-11-22
**理由**:
- 依赖缺失是阻塞性问题，影响100%省份
- 配置问题只影响64.5%省份，且可能根本原因也是依赖缺失
- 先解决依赖，再测试已验证省份，可快速获得反馈

### 决策2：先聚焦已验证的11个省份，再扩展到未验证省份
**时间**: 2025-11-22
**理由**:
- 已验证省份配置可靠性高，成功率更高
- 可快速积累200-500份文档，满足最低要求
- 未验证省份配置可能需要逐个调试，时间成本高
- 符合CLAUDE.md的"渐进式实施"原则

### 决策3：暂时跳过浙江省，优先其他可访问省份
**时间**: 2025-11-22
**理由**:
- 浙江省标记"暂时无法访问"，可能是临时问题
- 其他10个已验证省份足以满足首批示范需求
- 浙江省可后续单独处理

---

## 9. 风险提示

### 风险1：即使安装依赖，部分省份仍可能爬取失败
**可能性**: 中等
**影响**: 数据完整性
**缓解措施**:
- 先测试已验证省份
- 记录失败原因
- 准备备选省份名单

### 风险2：网站结构变化导致爬虫失效
**可能性**: 中低
**影响**: 部分省份数据缺失
**缓解措施**:
- 使用灵活的CSS选择器
- 增加异常处理和日志
- 人工抽查验证

### 风险3：QPS限制触发IP封禁
**可能性**: 低
**影响**: 临时无法访问
**缓解措施**:
- 严格遵守QPS限制（0.7）
- 随机抖动
- 指数退避重试

---

## 10. 下一步行动清单

### 立即执行（必须）
- [ ] 安装Python依赖：`pip3 install -r scripts/requirements.txt`
- [ ] 验证爬虫可运行：`python3 scripts/crawl_provinces.py --help`
- [ ] 测试广东省爬取：`python3 scripts/crawl_provinces.py 广东省 --test`

### 优先执行（强烈建议）
- [ ] 爬取11个已验证省份（测试模式，3页）
- [ ] 验证数据质量（至少50-100条）
- [ ] 手动验证浙江省网站可访问性

### 后续执行（可选）
- [ ] 创建省份配置验证脚本
- [ ] 验证20个未验证省份
- [ ] 实现中央政策爬虫
- [ ] 完整数据质量验证

---

## 11. 总结

### 核心问题
❌ **数据收集阶段从未真正执行**，根本原因是Python依赖未安装。

### 影响范围
- 🔴 全部31个省份（100%）
- 🔴 中央政策爬取
- 🔴 统计数据和专利数据爬取

### 解决路径
1. **立即**：安装依赖（5-10分钟）
2. **优先**：测试已验证省份（11个，1-2小时）
3. **次优先**：验证未验证省份（20个，2-4小时）
4. **最后**：完整数据质量验证（30分钟）

### 预期成果
- 短期（1-2天）：至少200-500份省级政策文档
- 中期（3-5天）：全部31省份覆盖，1000+份文档
- 长期（1-2周）：完整数据集（政策+统计+专利）

---

*本报告遵循CLAUDE.md规范，完整记录分析过程和关键决策。*
