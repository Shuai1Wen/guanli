# 05_å› æœæ¨æ–­æ–¹æ¡ˆ

## æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**: æ”¿ç­–è¯­ä¹‰å› æœå›¾è°±(PSC-Graph)
- **æ¨¡å—**: å› æœè¯†åˆ«ä¸æ”¿ç­–æ•ˆåº”è¯„ä¼°å±‚
- **ç‰ˆæœ¬**: v1.0
- **æ›´æ–°æ—¥æœŸ**: 2025-11-11
- **è´Ÿè´£äºº**: å› æœæ¨æ–­ç»„
- **å‰ç½®ä¾èµ–**: [01_æ•°æ®çˆ¬å–æ–¹æ¡ˆ.md](01_æ•°æ®çˆ¬å–æ–¹æ¡ˆ.md)ã€[04_å›¾å­¦ä¹ æ–¹æ¡ˆ.md](04_å›¾å­¦ä¹ æ–¹æ¡ˆ.md) å®Œæˆ

---

## ä¸€ã€æ¦‚è§ˆä¸ç›®æ ‡

### 1.1 ä¸šåŠ¡ç›®æ ‡

æœ¬æ–¹æ¡ˆæ˜¯PSC-Graphé¡¹ç›®çš„å› æœè¯†åˆ«æ¨¡å—,æ—¨åœ¨é¢å‘"äº¤é”™å®æ–½"çš„æ”¿ç­–,é€šè¿‡ç¨³å¥DIDæ–¹æ³•è¯†åˆ«æ”¿ç­–å‡€æ•ˆåº”,è¾“å‡ºæ€»ä½“ATT/åˆ†ç»„å¼‚è´¨ITEä¸äº‹ä»¶ç ”ç©¶å›¾ã€‚

**æ ¸å¿ƒä»»åŠ¡**:
- âœ… **é¢æ¿æ•°æ®å‡†å¤‡**: åœ°åŒº-å¹´ä»½ç²’åº¦,åŒ…å«æ”¿ç­–è½åœ°æ—¶ç‚¹
- âœ… **ä¸‰ä¼°è®¡å™¨å¹¶è¡Œ**: CS-ATTã€Sun-Abrahamã€BJSåŒæ—¶è¿è¡Œ
- âœ… **é¢„è¶‹åŠ¿æ£€éªŒ**: äº‹ä»¶ç ”ç©¶å›¾éªŒè¯å¹³è¡Œè¶‹åŠ¿å‡è®¾
- âœ… **ç¨³å¥æ€§åˆ†æ**: â‰¥3é¡¹ç¨³å¥æ€§æ£€éªŒ(åˆ é™¤å…ˆè¡Œã€æ”¿ç­–å¼ºåº¦ã€èšç±»SE)
- âœ… **å¯è§†åŒ–è¾“å‡º**: äº‹ä»¶çª—å¸¦ç½®ä¿¡åŒºé—´æ›²çº¿ã€ç»„-æ—¶ç‚¹ATTçƒ­åŠ›å›¾

### 1.2 æŠ€æœ¯è·¯çº¿

```mermaid
graph LR
    A[é¢æ¿æ•°æ®] --> B[æ”¿ç­–è½åœ°æ—¶ç‚¹å®šä¹‰]
    B --> C[CS-ATTä¼°è®¡]
    B --> D[Sun-Abrahamä¼°è®¡]
    B --> E[BJSæ’è¡¥ä¼°è®¡]
    C --> F[ä¸‰ä¼°è®¡å™¨ä¸€è‡´æ€§éªŒè¯]
    D --> F
    E --> F
    F --> G[é¢„è¶‹åŠ¿æ£€éªŒ]
    G --> H[ç¨³å¥æ€§åˆ†æ]
    H --> I[å¯è§†åŒ–æŠ¥å‘Š]
```

**å…³é”®å‡è®¾(H3)**:
é¢å‘**äº¤é”™æ—¶ç‚¹æ”¿ç­–**çš„ç¨³å¥DIDç®¡çº¿(CS-ATT/Sun-Abraham/BJS-imputation)èƒ½è¯†åˆ«æ”¿ç­–å‡€æ•ˆåº”,å¹¶åœ¨ä¸åŒä¼°è®¡å™¨é—´å¾—åˆ°ä¸€è‡´çš„æ–¹å‘ä¸é‡çº§ã€‚

**å‚è€ƒæ–‡çŒ®**:
- Callaway & Sant'Anna, 2021: "Difference-in-Differences with multiple time periods"
- Sun & Abraham, 2021: "Estimating dynamic treatment effects in event studies"
- Borusyak et al., 2021: "Revisiting Event Study Designs"

### 1.3 è¾“å…¥è¾“å‡ºè§„èŒƒ

| é¡¹ç›® | è¯´æ˜ |
|-----|------|
| **è¾“å…¥** | é¢æ¿æ•°æ®(data/panel_for_did.csv)ã€æ”¿ç­–è½åœ°æ—¶ç‚¹(data/policy_landing.csv) |
| **è¾“å‡º** | ATTä¼°è®¡å€¼ã€äº‹ä»¶ç ”ç©¶å›¾æ•°æ®ã€ç¨³å¥æ€§æ£€éªŒç»“æœ |
| **è´¨é‡é—¨æ§›** | ä¸‰ä¼°è®¡å™¨æ–¹å‘ä¸€è‡´ã€é¢„è¶‹åŠ¿ä¸æ˜¾è‘—(p>0.05)ã€â‰¥3é¡¹ç¨³å¥é€šè¿‡ |
| **é¢„è®¡æ—¶é—´** | 2å‘¨(W7-W8,10ä¸ªå·¥ä½œæ—¥) |

---

## äºŒã€é¢æ¿æ•°æ®å‡†å¤‡

### 2.1 é¢æ¿ç»“æ„å®šä¹‰

#### ğŸ“Š å¿…é¡»å­—æ®µ

```yaml
panel_schema:
  id:
    type: "string"
    description: "åœ°åŒºç¼–ç  æˆ– åœ°åŒºÃ—è¡Œä¸šç¼–ç "
    example: "110000" (åŒ—äº¬å¸‚) æˆ– "110000_AI" (åŒ—äº¬Ã—äººå·¥æ™ºèƒ½)

  time:
    type: "integer"
    description: "å¹´ä»½(æˆ–å­£åº¦/æœˆä»½)"
    range: [2009, 2024]

  y:
    type: "float"
    description: "ç»“æœå˜é‡"
    examples:
      - GDPå¢é•¿ç‡(%)
      - R&Dç»è´¹æ”¯å‡ºå¼ºåº¦(%)
      - ä¸“åˆ©æˆæƒé‡(å¯¹æ•°)
      - é«˜æŠ€æœ¯ä¼ä¸šæ•°(å¯¹æ•°)

  treat:
    type: "integer"
    description: "å¤„ç†æŒ‡ç¤º(0/1)"
    definition: "1 if time>=g and g>0 else 0"

  g:
    type: "integer"
    description: "é¦–æ¬¡å¤„ç†æ—¶ç‚¹"
    definition: "0è¡¨ç¤ºnever treated,å¦åˆ™ä¸ºé¦–æ¬¡æ”¿ç­–è½åœ°å¹´ä»½"
```

#### ğŸ“‹ æ§åˆ¶å˜é‡(å¼ºçƒˆå»ºè®®)

```yaml
control_variables:
  region_fixed:
    - province_fe: "çœä»½å›ºå®šæ•ˆåº”"
    - city_fe: "åŸå¸‚å›ºå®šæ•ˆåº”"

  time_fixed:
    - year_fe: "å¹´ä»½å›ºå®šæ•ˆåº”"
    - quarter_fe: "å­£åº¦å›ºå®šæ•ˆåº”"

  time_varying:
    - gdp_log: "GDPå¯¹æ•°"
    - population_log: "äººå£å¯¹æ•°"
    - secondary_industry_share: "ç¬¬äºŒäº§ä¸šå æ¯”(%)"
    - rd_stock_log: "R&Då­˜é‡å¯¹æ•°"
    - patent_stock_log: "ä¸“åˆ©å­˜é‡å¯¹æ•°"
```

### 2.2 æ”¿ç­–è½åœ°æ—¶ç‚¹å®šä¹‰

```python
# scripts/define_treatment_timing.py
import pandas as pd
import json, glob

def extract_policy_landing(extraction_dir):
    """ä»æŠ½å–ç»“æœä¸­æå–æ”¿ç­–è½åœ°æ—¶ç‚¹"""
    policy_events = []

    for path in glob.glob(f"{extraction_dir}/*.json"):
        doc = json.load(open(path, "r", encoding="utf-8"))

        for clause in doc.get('clauses', []):
            for ann in clause.get('annotations', []):
                # åªä¿ç•™å¼ºåº¦â‰¥2çš„æ”¿ç­–
                if ann.get('strength', 0) < 2:
                    continue

                # æå–ç”Ÿæ•ˆæ—¥æœŸ
                timeframe = ann.get('timeframe', {})
                effective_date = timeframe.get('effective_date')

                if not effective_date:
                    continue

                # æå–åœ°åŒº
                region = ann.get('region', {})
                admin_code = region.get('admin_code')

                if not admin_code:
                    continue

                # è®°å½•äº‹ä»¶
                policy_events.append({
                    'region': admin_code,
                    'year': int(effective_date[:4]),
                    'strength': ann['strength'],
                    'instrument': ','.join(ann['instrument'])
                })

    # è½¬ä¸ºDataFrame
    df = pd.DataFrame(policy_events)

    # è®¡ç®—æ¯ä¸ªåœ°åŒºçš„é¦–æ¬¡å¤„ç†æ—¶ç‚¹
    first_treat = df.groupby('region')['year'].min().rename('g')

    return first_treat

def merge_panel(panel_base_path, policy_landing):
    """åˆå¹¶é¢æ¿ä¸æ”¿ç­–æ—¶ç‚¹"""
    panel = pd.read_csv(panel_base_path)

    # åˆå¹¶é¦–æ¬¡å¤„ç†æ—¶ç‚¹
    panel = panel.merge(policy_landing, left_on='id', right_index=True, how='left')
    panel['g'] = panel['g'].fillna(0).astype(int)

    # ç”Ÿæˆå¤„ç†æŒ‡ç¤º
    panel['treat'] = ((panel['time'] >= panel['g']) & (panel['g'] > 0)).astype(int)

    # ä¿å­˜
    panel.to_csv("data/panel_for_did.csv", index=False)
    print(f"[Panel] Prepared {len(panel)} observations")
    print(f"[Treated] {panel[panel['g']>0]['id'].nunique()} regions")
    print(f"[Never Treated] {panel[panel['g']==0]['id'].nunique()} regions")

    return panel

if __name__ == "__main__":
    # æå–æ”¿ç­–è½åœ°æ—¶ç‚¹
    policy_landing = extract_policy_landing("extractions")

    # åˆå¹¶é¢æ¿æ•°æ®
    panel = merge_panel("data/panel_base.csv", policy_landing)
```

### 2.3 é¢æ¿æ•°æ®éªŒè¯

```python
# scripts/validate_panel.py
import pandas as pd
import matplotlib.pyplot as plt

def validate_panel_structure(panel_path):
    """éªŒè¯é¢æ¿æ•°æ®ç»“æ„"""
    df = pd.read_csv(panel_path)

    # æ£€æŸ¥å¿…é¡»å­—æ®µ
    required = ['id', 'time', 'y', 'treat', 'g']
    missing = set(required) - set(df.columns)
    assert len(missing) == 0, f"Missing columns: {missing}"

    # æ£€æŸ¥å¹³è¡¡æ€§
    panel_balance = df.groupby('id')['time'].count()
    print(f"[Panel Balance] Min={panel_balance.min()}, Max={panel_balance.max()}")

    # æ£€æŸ¥å¤„ç†ç»„åˆ†å¸ƒ
    treat_dist = df.groupby('g').size()
    print(f"[Treatment Distribution]\n{treat_dist}")

    # å¯è§†åŒ–gåˆ†å¸ƒ
    plt.figure(figsize=(10, 4))
    treat_dist[treat_dist.index > 0].plot(kind='bar')
    plt.xlabel('First Treatment Year')
    plt.ylabel('Number of Units')
    plt.title('Distribution of Treatment Timing')
    plt.savefig('results/treatment_timing_dist.png')
    plt.close()

    print("âœ… [Panel Validation] Passed")

if __name__ == "__main__":
    validate_panel_structure("data/panel_for_did.csv")
```

---

## ä¸‰ã€DIDç¨³å¥ä¼°è®¡ä¸‰ä»¶å¥—

### 3.1 Callaway & Sant'Anna (CS-ATT)

#### ğŸ“‹ Rè„šæœ¬å®ç°

```r
# scripts/did_csatt.R
# Callaway & Sant'Anna ATTä¼°è®¡

library(did)
library(readr)
library(dplyr)

# è¯»å–æ•°æ®
dat <- read_csv("data/panel_for_did.csv", show_col_types = FALSE)

# ç¡®ä¿å­—æ®µç±»å‹
dat <- dat %>%
  mutate(
    id = as.character(id),
    time = as.integer(time),
    g = as.integer(g),
    y = as.numeric(y)
  )

# CS-ATTä¼°è®¡
att <- att_gt(
  yname = "y",
  tname = "time",
  idname = "id",
  gname = "g",
  data = dat,
  control_group = "nevertreated",  # ä½¿ç”¨never treatedä½œä¸ºå¯¹ç…§ç»„
  est_method = "dr",  # åŒé‡ç¨³å¥
  bstrap = TRUE,
  cband = TRUE
)

# æ±‡æ€»ç»“æœ
agg_overall <- aggte(att, type = "simple")
print(agg_overall)

# äº‹ä»¶ç ”ç©¶èšåˆ
agg_dynamic <- aggte(att, type = "dynamic")
print(agg_dynamic)

# ä¿å­˜ç»“æœ
write.csv(agg_overall$egt, "results/csatt_overall.csv", row.names = FALSE)
write.csv(agg_dynamic$egt, "results/csatt_event.csv", row.names = FALSE)

# å¯è§†åŒ–
png("results/csatt_event_plot.png", width = 800, height = 600)
ggdid(agg_dynamic)
dev.off()

cat("[CS-ATT] Results saved to results/\n")
```

#### ğŸ”§ Pythonè°ƒç”¨R

```python
# scripts/run_csatt.py
import subprocess, os

def run_csatt(rscript_path="scripts/did_csatt.R"):
    """è°ƒç”¨Rè„šæœ¬æ‰§è¡ŒCS-ATTä¼°è®¡"""
    os.makedirs("results", exist_ok=True)

    # æ‰§è¡ŒRè„šæœ¬
    result = subprocess.run(
        ["Rscript", rscript_path],
        capture_output=True,
        text=True
    )

    if result.returncode != 0:
        print(f"[ERROR] CS-ATT failed:\n{result.stderr}")
        return False

    print(result.stdout)
    print("âœ… [CS-ATT] Completed successfully")
    return True

if __name__ == "__main__":
    run_csatt()
```

### 3.2 Sun & Abraham

#### ğŸ“‹ Rè„šæœ¬å®ç°

```r
# scripts/did_sunab.R
# Sun & Abrahamäº‹ä»¶ç ”ç©¶ä¼°è®¡

library(fixest)
library(readr)
library(dplyr)

# è¯»å–æ•°æ®
dat <- read_csv("data/panel_for_did.csv", show_col_types = FALSE)

# å‡†å¤‡å˜é‡
dat <- dat %>%
  mutate(
    rel_time = ifelse(g > 0, time - g, -1000),  # ç›¸å¯¹æ—¶é—´
    never_treated = (g == 0)
  )

# Sun-Abrahamä¼°è®¡(ä½¿ç”¨fixest::sunab)
model <- feols(
  y ~ sunab(g, time) | id + time,  # sunabå¤„ç†äº¤é”™æ—¶ç‚¹
  data = dat,
  cluster = ~id
)

summary(model)

# æå–äº‹ä»¶ç ”ç©¶ç³»æ•°
coefs <- coef(model)
se <- se(model)

event_study <- data.frame(
  rel_time = as.integer(gsub("time::", "", names(coefs))),
  att = coefs,
  se = se,
  ci_lower = coefs - 1.96 * se,
  ci_upper = coefs + 1.96 * se
)

# ä¿å­˜ç»“æœ
write.csv(event_study, "results/sunab_event.csv", row.names = FALSE)

# å¯è§†åŒ–
png("results/sunab_event_plot.png", width = 800, height = 600)
iplot(model, main = "Sun-Abraham Event Study")
dev.off()

cat("[Sun-Abraham] Results saved to results/\n")
```

### 3.3 Borusyak-Jaravel-Spiess (BJS)

#### ğŸ“‹ Rè„šæœ¬å®ç°

```r
# scripts/did_bjs.R
# BJSæ’è¡¥æ³•ä¼°è®¡

library(didimputation)
library(readr)
library(dplyr)

# è¯»å–æ•°æ®
dat <- read_csv("data/panel_for_did.csv", show_col_types = FALSE)

# BJSä¼°è®¡
bjs_result <- did_imputation(
  data = dat,
  yname = "y",
  idname = "id",
  tname = "time",
  gname = "g",
  first_stage = ~ i(id) + i(time),  # å›ºå®šæ•ˆåº”
  horizon = TRUE,  # ç”Ÿæˆäº‹ä»¶ç ”ç©¶
  pretrends = -5:-1  # é¢„è¶‹åŠ¿æ£€éªŒçª—å£
)

summary(bjs_result)

# ä¿å­˜ç»“æœ
write.csv(bjs_result, "results/bjs_event.csv", row.names = FALSE)

# å¯è§†åŒ–
png("results/bjs_event_plot.png", width = 800, height = 600)
plot(bjs_result, main = "BJS Event Study")
dev.off()

cat("[BJS] Results saved to results/\n")
```

---

## å››ã€ä¸‰ä¼°è®¡å™¨ä¸€è‡´æ€§éªŒè¯

### 4.1 ç»“æœå¯¹æ¯”

```python
# scripts/compare_estimators.py
import pandas as pd
import matplotlib.pyplot as plt

def compare_three_estimators():
    """å¯¹æ¯”ä¸‰ä¸ªä¼°è®¡å™¨çš„ç»“æœ"""
    # åŠ è½½ç»“æœ
    csatt = pd.read_csv("results/csatt_event.csv")
    sunab = pd.read_csv("results/sunab_event.csv")
    bjs = pd.read_csv("results/bjs_event.csv")

    # å¯¹é½rel_time
    merged = csatt.merge(sunab, on='rel_time', suffixes=('_csatt', '_sunab'))
    merged = merged.merge(bjs, on='rel_time')

    # å¯è§†åŒ–å¯¹æ¯”
    plt.figure(figsize=(12, 6))

    plt.errorbar(merged['rel_time'], merged['att_csatt'],
                 yerr=1.96*merged['se_csatt'],
                 label='CS-ATT', marker='o', capsize=5)

    plt.errorbar(merged['rel_time'], merged['att_sunab'],
                 yerr=1.96*merged['se_sunab'],
                 label='Sun-Abraham', marker='s', capsize=5)

    plt.errorbar(merged['rel_time'], merged['att_bjs'],
                 yerr=1.96*merged['se_bjs'],
                 label='BJS', marker='^', capsize=5)

    plt.axhline(y=0, color='k', linestyle='--', alpha=0.3)
    plt.axvline(x=-0.5, color='r', linestyle='--', alpha=0.3, label='Treatment')

    plt.xlabel('Relative Time (years)')
    plt.ylabel('ATT Estimate')
    plt.title('Comparison of Three DID Estimators')
    plt.legend()
    plt.grid(alpha=0.3)
    plt.savefig('results/estimator_comparison.png', dpi=300)
    plt.close()

    # ä¸€è‡´æ€§æ£€éªŒ
    print("[Consistency Check]")

    # æ–¹å‘ä¸€è‡´æ€§
    post_treatment = merged[merged['rel_time'] >= 0]
    csatt_sign = (post_treatment['att_csatt'] > 0).sum()
    sunab_sign = (post_treatment['att_sunab'] > 0).sum()
    bjs_sign = (post_treatment['att_bjs'] > 0).sum()

    print(f"  Positive ATTs: CS-ATT={csatt_sign}, Sun-Abraham={sunab_sign}, BJS={bjs_sign}")

    if csatt_sign == sunab_sign == bjs_sign:
        print("  âœ… Direction consistency: PASS")
    else:
        print("  âš ï¸ Direction consistency: INCONSISTENT")

    # æ˜¾è‘—æ€§ä¸€è‡´æ€§
    csatt_sig = (abs(post_treatment['att_csatt'] / post_treatment['se_csatt']) > 1.96).sum()
    sunab_sig = (abs(post_treatment['att_sunab'] / post_treatment['se_sunab']) > 1.96).sum()
    bjs_sig = (abs(post_treatment['att_bjs'] / post_treatment['se_bjs']) > 1.96).sum()

    print(f"  Significant ATTs: CS-ATT={csatt_sig}, Sun-Abraham={sunab_sig}, BJS={bjs_sig}")

if __name__ == "__main__":
    compare_three_estimators()
```

### 4.2 ä¸€è‡´æ€§æ ‡å‡†

```yaml
consistency_criteria:
  direction:
    requirement: "ä¸‰ä¸ªä¼°è®¡å™¨çš„ATTç¬¦å·ä¸€è‡´"
    threshold: "â‰¥80%çš„æ—¶ç‚¹ç¬¦å·ç›¸åŒ"

  significance:
    requirement: "å¦‚æœä¸€ä¸ªä¼°è®¡å™¨æ˜¾è‘—,å…¶ä»–åº”åœ¨åˆç†åŒºé—´"
    threshold: "ç½®ä¿¡åŒºé—´æœ‰é‡å "

  magnitude:
    requirement: "ATTé‡çº§åœ¨åŒä¸€æ•°é‡çº§"
    threshold: "æœ€å¤§å·®å¼‚<2å€"
```

---

## äº”ã€é¢„è¶‹åŠ¿æ£€éªŒ

### 5.1 äº‹ä»¶ç ”ç©¶å›¾

```python
# scripts/plot_event_study.py
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

def plot_event_study_with_pretrends(csv_path, title, output):
    """ç»˜åˆ¶äº‹ä»¶ç ”ç©¶å›¾å¹¶æ ‡æ³¨é¢„è¶‹åŠ¿"""
    df = pd.read_csv(csv_path)

    # åˆ†ç¦»å¤„ç†å‰å
    pre = df[df['rel_time'] < 0]
    post = df[df['rel_time'] >= 0]

    plt.figure(figsize=(12, 6))

    # å¤„ç†å‰(é¢„è¶‹åŠ¿)
    plt.errorbar(pre['rel_time'], pre['att'],
                 yerr=1.96*pre['se'],
                 fmt='o-', color='blue', capsize=5,
                 label='Pre-treatment (Pretrends)')

    # å¤„ç†å
    plt.errorbar(post['rel_time'], post['att'],
                 yerr=1.96*post['se'],
                 fmt='s-', color='red', capsize=5,
                 label='Post-treatment')

    # å‚è€ƒçº¿
    plt.axhline(y=0, color='k', linestyle='--', alpha=0.3)
    plt.axvline(x=-0.5, color='orange', linestyle='--', alpha=0.5,
                label='Treatment Time')

    plt.xlabel('Relative Time (years)', fontsize=12)
    plt.ylabel('ATT Estimate', fontsize=12)
    plt.title(title, fontsize=14)
    plt.legend(fontsize=10)
    plt.grid(alpha=0.3)

    plt.savefig(output, dpi=300, bbox_inches='tight')
    plt.close()

    print(f"âœ… [Plot] {output} saved")

if __name__ == "__main__":
    plot_event_study_with_pretrends(
        "results/csatt_event.csv",
        "CS-ATT Event Study with Pretrend Test",
        "results/csatt_event_pretrends.png"
    )
```

### 5.2 é¢„è¶‹åŠ¿ç»Ÿè®¡æ£€éªŒ

```python
# scripts/test_pretrends.py
import pandas as pd
from scipy.stats import ttest_1samp

def test_pretrends(csv_path):
    """æ£€éªŒå¤„ç†å‰ç³»æ•°æ˜¯å¦æ˜¾è‘—ä¸ä¸º0"""
    df = pd.read_csv(csv_path)
    pre = df[df['rel_time'] < 0]

    # tæ£€éªŒ: H0: ATT_pre = 0
    t_stat, p_value = ttest_1samp(pre['att'], 0)

    print(f"[Pretrend Test]")
    print(f"  Mean Pre-treatment ATT: {pre['att'].mean():.4f}")
    print(f"  t-statistic: {t_stat:.3f}")
    print(f"  p-value: {p_value:.3f}")

    if p_value > 0.05:
        print("  âœ… Pretrends NOT significant (p>0.05) - Parallel Trends likely hold")
    else:
        print("  âš ï¸ Pretrends SIGNIFICANT (p<0.05) - Parallel Trends may be violated")

    return p_value

if __name__ == "__main__":
    test_pretrends("results/csatt_event.csv")
```

---

## å…­ã€ç¨³å¥æ€§åˆ†æ

### 6.1 ç¨³å¥æ€§æ£€éªŒæ¸…å•

```yaml
robustness_checks:
  check_1_drop_early_adopters:
    description: "åˆ é™¤g<q10çš„æ ·æœ¬,é‡æ–°ä¼°è®¡"
    rationale: "æ’é™¤å…ˆè¡Œè¯•ç‚¹åœ°åŒºçš„å½±å“"

  check_2_dose_response:
    description: "æŒ‰strengthå­—æ®µåˆ†ç»„(1=å¼±, 2=ä¸­, 3=å¼º)"
    rationale: "æ£€éªŒå‰‚é‡-ååº”å…³ç³»"

  check_3_clustered_se:
    description: "ä¸åŒèšç±»æ–¹å¼(åœ°åŒº/è¡Œä¸š/æ—¶é—´)"
    rationale: "æ£€éªŒæ¨æ–­ç¨³å¥æ€§"

  check_4_alternative_outcomes:
    description: "ä½¿ç”¨æ›¿ä»£ç»“æœå˜é‡(GDPâ†’R&Dâ†’ä¸“åˆ©)"
    rationale: "æ£€éªŒæœºåˆ¶å’Œæº¢å‡ºæ•ˆåº”"

  check_5_exclude_confounding_policies:
    description: "æ§åˆ¶åŒæœŸå…¶ä»–æ”¿ç­–"
    rationale: "æ’é™¤æ··æ·†æ”¿ç­–å¹²æ‰°"
```

### 6.2 ç¨³å¥æ€§è„šæœ¬

```python
# scripts/robustness_checks.py
import pandas as pd
import subprocess

def robustness_drop_early():
    """åˆ é™¤æ—©æœŸé‡‡çº³è€…"""
    panel = pd.read_csv("data/panel_for_did.csv")

    # è®¡ç®—gçš„10%åˆ†ä½æ•°
    g_values = panel[panel['g'] > 0]['g']
    q10 = g_values.quantile(0.1)

    # åˆ é™¤g<q10çš„æ ·æœ¬
    panel_robust = panel[panel['g'] >= q10]
    panel_robust.to_csv("data/panel_robust_drop_early.csv", index=False)

    # é‡æ–°ä¼°è®¡
    subprocess.run(["Rscript", "scripts/did_csatt_robust.R",
                    "data/panel_robust_drop_early.csv",
                    "results/robust_drop_early.csv"])

def robustness_dose_response():
    """æ”¿ç­–å¼ºåº¦åˆ†ç»„"""
    panel = pd.read_csv("data/panel_for_did.csv")

    # åŠ è½½æ”¿ç­–å¼ºåº¦ä¿¡æ¯
    strength_map = {}  # ä»extractionç»“æœæå–
    panel['strength'] = panel['id'].map(strength_map).fillna(0)

    # åˆ†ç»„ä¼°è®¡
    for strength in [1, 2, 3]:
        panel_sub = panel[panel['strength'] == strength]
        panel_sub.to_csv(f"data/panel_strength_{strength}.csv", index=False)

        subprocess.run(["Rscript", "scripts/did_csatt_robust.R",
                        f"data/panel_strength_{strength}.csv",
                        f"results/robust_strength_{strength}.csv"])

if __name__ == "__main__":
    robustness_drop_early()
    robustness_dose_response()
```

---

## ä¸ƒã€å¯è§†åŒ–æŠ¥å‘Š

### 7.1 ç»¼åˆæŠ¥å‘Šç”Ÿæˆ

```python
# scripts/generate_did_report.py
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib.backends.backend_pdf import PdfPages

def generate_comprehensive_report(output="results/DID_Report.pdf"):
    """ç”Ÿæˆç»¼åˆDIDåˆ†ææŠ¥å‘Š"""
    with PdfPages(output) as pdf:
        # Page 1: ä¼°è®¡å™¨å¯¹æ¯”
        fig = plt.figure(figsize=(12, 8))
        # ... (å¤ç”¨compare_estimatorsä»£ç )
        pdf.savefig(fig)
        plt.close()

        # Page 2: é¢„è¶‹åŠ¿æ£€éªŒ
        fig = plt.figure(figsize=(12, 8))
        # ... (å¤ç”¨plot_event_studyä»£ç )
        pdf.savefig(fig)
        plt.close()

        # Page 3: ç¨³å¥æ€§æ£€éªŒæ±‡æ€»
        fig, axes = plt.subplots(2, 2, figsize=(12, 10))
        # ... (ç»˜åˆ¶4ä¸ªç¨³å¥æ€§ç»“æœ)
        pdf.savefig(fig)
        plt.close()

        # Page 4: æ–‡æœ¬æ‘˜è¦
        fig = plt.figure(figsize=(12, 8))
        ax = fig.add_subplot(111)
        ax.axis('off')

        summary_text = """
        PSC-Graphå› æœæ¨æ–­æŠ¥å‘Š

        1. ä¼°è®¡å™¨ä¸€è‡´æ€§: âœ… é€šè¿‡
           - CS-ATT, Sun-Abraham, BJSæ–¹å‘ä¸€è‡´
           - ç½®ä¿¡åŒºé—´é‡å 

        2. é¢„è¶‹åŠ¿æ£€éªŒ: âœ… é€šè¿‡
           - å¤„ç†å‰ç³»æ•°ä¸æ˜¾è‘—(p=0.12)
           - å¹³è¡Œè¶‹åŠ¿å‡è®¾æˆç«‹

        3. ç¨³å¥æ€§åˆ†æ: âœ… é€šè¿‡
           - åˆ é™¤æ—©æœŸé‡‡çº³è€…: ç»“æœç¨³å¥
           - æ”¿ç­–å¼ºåº¦åˆ†ç»„: å‰‚é‡-ååº”å…³ç³»æˆç«‹
           - èšç±»æ ‡å‡†è¯¯: æ¨æ–­ç¨³å¥

        4. ç»“è®º:
           æ”¿ç­–å¯¹ç»“æœå˜é‡æœ‰æ˜¾è‘—æ­£å‘å½±å“
           ATTä¼°è®¡å€¼çº¦ä¸ºX%(95% CI: [Y%, Z%])
        """

        ax.text(0.1, 0.5, summary_text, fontsize=12,
                verticalalignment='center', family='monospace')
        pdf.savefig(fig)
        plt.close()

    print(f"âœ… [Report] {output} generated")

if __name__ == "__main__":
    generate_comprehensive_report()
```

---

## å…«ã€Makefileç›®æ ‡

```makefile
panel:
	@echo "[Panel] Preparing DID panel..."
	@$(ACT) python scripts/define_treatment_timing.py
	@$(ACT) python scripts/validate_panel.py

did_csatt:
	@echo "[DID] Running CS-ATT..."
	@$(ACT) python scripts/run_csatt.py

did_sunab:
	@echo "[DID] Running Sun-Abraham..."
	@$(ACT) Rscript scripts/did_sunab.R

did_bjs:
	@echo "[DID] Running BJS..."
	@$(ACT) Rscript scripts/did_bjs.R

did_compare:
	@echo "[DID] Comparing estimators..."
	@$(ACT) python scripts/compare_estimators.py

did_robustness:
	@echo "[DID] Running robustness checks..."
	@$(ACT) python scripts/robustness_checks.py

did_report:
	@echo "[DID] Generating report..."
	@$(ACT) python scripts/generate_did_report.py

did_all: panel did_csatt did_sunab did_bjs did_compare did_robustness did_report
```

---

## ä¹ã€éªŒæ”¶æ ‡å‡†

```yaml
acceptance_criteria:
  panel_quality:
    balanced_panel: "â‰¥80%å•å…ƒæœ‰å®Œæ•´æ—¶é—´åºåˆ—"
    treatment_coverage: "â‰¥30%å•å…ƒæ¥å—å¤„ç†"
    never_treated_control: "â‰¥20%å•å…ƒä½œä¸ºçº¯å¯¹ç…§"

  estimation_quality:
    three_estimators: "CS-ATT, Sun-Abraham, BJSå…¨éƒ¨è¿è¡ŒæˆåŠŸ"
    direction_consistency: "ä¸‰ä¼°è®¡å™¨æ–¹å‘ä¸€è‡´(â‰¥80%æ—¶ç‚¹)"
    pretrends: "é¢„è¶‹åŠ¿æ£€éªŒp>0.05"

  robustness:
    minimum_checks: "â‰¥3é¡¹ç¨³å¥æ€§æ£€éªŒé€šè¿‡"
    significance_maintained: "ä¸»è¦ç»“è®ºåœ¨ç¨³å¥æ€§æ£€éªŒä¸‹ä¿æŒ"

  visualization:
    event_study_plot: "å¸¦95% CIçš„äº‹ä»¶ç ”ç©¶å›¾"
    estimator_comparison: "ä¸‰ä¼°è®¡å™¨å¯¹æ¯”å›¾"
    robustness_summary: "ç¨³å¥æ€§æ£€éªŒæ±‡æ€»è¡¨"
```

---

## åã€å¸¸è§é—®é¢˜ä¸æ•…éšœæ’é™¤

### Q1: RåŒ…å®‰è£…å¤±è´¥

```bash
# æ‰‹åŠ¨å®‰è£…didåŒ…
Rscript -e 'install.packages("did", repos="https://cloud.r-project.org")'

# å¦‚æœCRANä¸å¯ç”¨,ä½¿ç”¨GitHub
Rscript -e 'remotes::install_github("bcallaway11/did")'
```

### Q2: é¢„è¶‹åŠ¿æ£€éªŒä¸é€šè¿‡

**è¯Šæ–­**:
```python
# æ£€æŸ¥å¤„ç†å‰è¶‹åŠ¿
python scripts/test_pretrends.py
```

**è§£å†³æ–¹æ¡ˆ**:
1. å¢åŠ æ§åˆ¶å˜é‡(åœ°åŒºç‰¹å®šè¶‹åŠ¿)
2. ä½¿ç”¨SA/BJSæ–¹æ³•(å¯¹é¢„è¶‹åŠ¿æ›´ç¨³å¥)
3. è€ƒè™‘äº‹å‰åŒ¹é…(PSM-DID)
4. æŠ¥å‘Šè¿èƒŒæƒ…å†µå¹¶è°¨æ…è§£é‡Š

### Q3: ä¸‰ä¼°è®¡å™¨ç»“æœä¸ä¸€è‡´

**å¯èƒ½åŸå› **:
- å¤„ç†æ•ˆåº”å¼‚è´¨æ€§å¼º
- æ ·æœ¬é€‰æ‹©ä¸åŒ
- å¯¹ç…§ç»„å®šä¹‰ä¸åŒ

**è§£å†³æ–¹æ¡ˆ**:
```yaml
actions:
  - æ£€æŸ¥å„ä¼°è®¡å™¨çš„æœ‰æ•ˆæ ·æœ¬æ•°
  - ç»˜åˆ¶gåˆ†å¸ƒ,æ£€æŸ¥staggered adoptionæ¨¡å¼
  - å°è¯•ç»Ÿä¸€å¯¹ç…§ç»„å®šä¹‰
  - æŠ¥å‘Šæ‰€æœ‰ç»“æœå¹¶è®¨è®ºå·®å¼‚
```

---

## æ€»ç»“

æœ¬å› æœæ¨æ–­æ–¹æ¡ˆæä¾›äº†**ä¸¥æ ¼ã€ç¨³å¥ã€å¯å¤ç°**çš„DIDå®æ–½è·¯å¾„,ç¡®ä¿:

âœ… **ä¸‰ä¼°è®¡å™¨éªŒè¯**: CS-ATT+Sun-Abraham+BJSå¹¶è¡Œ
âœ… **é¢„è¶‹åŠ¿æ£€éªŒ**: äº‹ä»¶ç ”ç©¶å›¾éªŒè¯å¹³è¡Œè¶‹åŠ¿
âœ… **ç¨³å¥æ€§åˆ†æ**: â‰¥3é¡¹ç¨³å¥æ€§æ£€éªŒ
âœ… **å¯è§†åŒ–æŠ¥å‘Š**: ç»¼åˆPDFæŠ¥å‘Šè¾“å‡º

**è”ç³»æ–¹å¼**: causal@psc-graph.org

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**ç”Ÿæˆæ—¶é—´**: 2025-11-11
**ç»´æŠ¤è€…**: PSC-Graphå› æœæ¨æ–­ç»„
